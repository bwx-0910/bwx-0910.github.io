<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“– ç”µå­ä¹¦é˜…è¯»å™¨</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“–</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: #1a1a2e;
            color: #eaeaea;
            min-height: 100vh;
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        .navbar {
            background: #16213e;
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: #eaeaea;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .navbar-brand:hover {
            color: #e94560;
        }

        .navbar-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .btn {
            background: #e94560;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn:hover {
            background: #ff6b6b;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #0f3460;
        }

        .btn-secondary:hover {
            background: #1a4a7a;
        }

        /* ä¸»å®¹å™¨ */
        .main-container {
            margin-top: 70px;
            display: flex;
            height: calc(100vh - 70px);
        }

        /* ä¾§è¾¹æ  - ä¹¦æ¶ */
        .sidebar {
            width: 280px;
            background: #16213e;
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-title {
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: #e94560;
        }

        .book-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .book-item {
            background: #0f3460;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .book-item:hover {
            border-color: #e94560;
        }

        .book-item.active {
            border-color: #e94560;
            background: rgba(233, 69, 96, 0.2);
        }

        .book-item-title {
            font-weight: 600;
            margin-bottom: 5px;
            word-break: break-all;
            font-size: 0.95rem;
        }

        .book-item-info {
            font-size: 0.8rem;
            color: #a0a0a0;
        }

        .book-item-delete {
            float: right;
            background: none;
            border: none;
            color: #a0a0a0;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .book-item-delete:hover {
            color: #e94560;
        }

        /* é˜…è¯»åŒºåŸŸ */
        .reader-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #1a1a2e;
        }

        /* é˜…è¯»å™¨å·¥å…·æ  */
        .reader-toolbar {
            background: #16213e;
            padding: 10px 20px;
            display: none;
            align-items: center;
            justify-content: center;
            gap: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .reader-toolbar.active {
            display: flex;
        }

        .page-nav {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .page-info {
            color: #a0a0a0;
            font-size: 0.9rem;
            min-width: 120px;
            text-align: center;
        }

        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .zoom-level {
            color: #a0a0a0;
            font-size: 0.9rem;
            min-width: 50px;
            text-align: center;
        }

        /* é˜…è¯»è§†å›¾ */
        .reader-view {
            flex: 1;
            overflow: auto;
            display: none;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            background: #2d2d2d;
        }

        .reader-view.active {
            display: flex;
        }

        #pdf-canvas {
            max-width: 100%;
            box-shadow: 0 5px 30px rgba(0,0,0,0.5);
        }

        #epub-view {
            width: 100%;
            max-width: 800px;
            min-height: 500px;
            background: white;
            box-shadow: 0 5px 30px rgba(0,0,0,0.5);
        }

        /* æ¬¢è¿é¡µé¢ */
        .welcome-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 40px;
        }

        .welcome-screen.hidden {
            display: none;
        }

        .welcome-icon {
            font-size: 5rem;
            margin-bottom: 20px;
        }

        .welcome-title {
            font-size: 2rem;
            margin-bottom: 15px;
        }

        .welcome-desc {
            color: #a0a0a0;
            margin-bottom: 30px;
            max-width: 500px;
            line-height: 1.8;
        }

        .format-list {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .format-badge {
            background: #0f3460;
            padding: 10px 25px;
            border-radius: 20px;
            font-weight: 500;
        }

        /* æ‹–æ”¾åŒºåŸŸ */
        .drop-zone {
            border: 3px dashed #e94560;
            border-radius: 20px;
            padding: 50px 80px;
            margin: 30px 0;
            transition: all 0.3s;
            cursor: pointer;
        }

        .drop-zone:hover {
            background: rgba(233, 69, 96, 0.1);
        }

        .drop-zone-text {
            font-size: 1.1rem;
            color: #a0a0a0;
        }

        #file-input {
            display: none;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .loading.active {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #0f3460;
            border-top-color: #e94560;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 20px;
        }

        /* é”™è¯¯æç¤º */
        .error-msg {
            background: #ff6b6b;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            margin: 20px;
            display: none;
        }

        .error-msg.show {
            display: block;
        }

        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            
            .navbar-controls {
                gap: 8px;
            }
            
            .btn {
                padding: 8px 12px;
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <a href="index.html" class="navbar-brand">
            <span>ğŸ“š</span>
            <span>è¿”å›é¦–é¡µ</span>
        </a>
        <div class="navbar-controls">
            <label for="file-input" class="btn">
                ğŸ“‚ æ‰“å¼€æ–‡ä»¶
            </label>
            <input type="file" id="file-input" accept=".pdf,.epub">
        </div>
    </nav>

    <!-- ä¸»å®¹å™¨ -->
    <div class="main-container">
        <!-- ä¾§è¾¹æ ä¹¦æ¶ -->
        <aside class="sidebar" id="sidebar">
            <h2 class="sidebar-title">ğŸ“š æˆ‘çš„ä¹¦æ¶</h2>
            <div class="book-list" id="book-list">
                <p style="color: #a0a0a0; text-align: center;">ä¹¦æ¶ç©ºç©ºå¦‚ä¹Ÿ~<br>å¿«æ·»åŠ ä¸€æœ¬ä¹¦å§ï¼</p>
            </div>
        </aside>

        <!-- é˜…è¯»å™¨å®¹å™¨ -->
        <div class="reader-container">
            <!-- æ¬¢è¿é¡µé¢ -->
            <div class="welcome-screen" id="welcome-screen">
                <div class="welcome-icon">ğŸ“–</div>
                <h1 class="welcome-title">ç”µå­ä¹¦é˜…è¯»å™¨</h1>
                <p class="welcome-desc">
                    æ”¯æŒ PDF å’Œ EPUB æ ¼å¼çš„ç”µå­ä¹¦é˜…è¯»ã€‚<br>
                    ç‚¹å‡»ä¸Šæ–¹"æ‰“å¼€æ–‡ä»¶"æŒ‰é’®é€‰æ‹©ç”µå­ä¹¦ï¼Œæˆ–å°†æ–‡ä»¶æ‹–æ”¾åˆ°ä¸‹æ–¹åŒºåŸŸã€‚
                </p>
                <div class="drop-zone" id="drop-zone">
                    <p class="drop-zone-text">ğŸ“‚ ç‚¹å‡»é€‰æ‹©æ–‡ä»¶ï¼Œæˆ–å°†æ–‡ä»¶æ‹–æ”¾åˆ°è¿™é‡Œ</p>
                </div>
                <div class="format-list">
                    <span class="format-badge">ğŸ“„ PDF</span>
                    <span class="format-badge">ğŸ“• EPUB</span>
                </div>
                <div class="error-msg" id="error-msg"></div>
            </div>

            <!-- é˜…è¯»å™¨å·¥å…·æ  -->
            <div class="reader-toolbar" id="reader-toolbar">
                <div class="page-nav">
                    <button class="btn btn-secondary" id="prev-btn">â—€ ä¸Šä¸€é¡µ</button>
                    <span class="page-info" id="page-info">ç¬¬ 1 é¡µ / å…± 1 é¡µ</span>
                    <button class="btn btn-secondary" id="next-btn">ä¸‹ä¸€é¡µ â–¶</button>
                </div>
                <div class="zoom-controls">
                    <button class="btn btn-secondary" id="zoom-out-btn">â–</button>
                    <span class="zoom-level" id="zoom-level">100%</span>
                    <button class="btn btn-secondary" id="zoom-in-btn">â•</button>
                </div>
            </div>

            <!-- é˜…è¯»è§†å›¾ -->
            <div class="reader-view" id="reader-view">
                <canvas id="pdf-canvas"></canvas>
                <div id="epub-view"></div>
            </div>
        </div>
    </div>

    <!-- åŠ è½½åŠ¨ç”» -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p class="loading-text">æ­£åœ¨åŠ è½½...</p>
    </div>

    <!-- è„šæœ¬æ”¾åœ¨æœ€ååŠ è½½ -->
    <script src="https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
    <script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://unpkg.com/epubjs@0.3.93/dist/epub.min.js"></script>
    
    <script>
        // æ£€æŸ¥åº“æ˜¯å¦åŠ è½½æˆåŠŸ
        let pdfReady = false;
        let epubReady = false;

        // ç­‰å¾… DOM å’Œåº“åŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', init);

        function init() {
            // æ£€æŸ¥ PDF.js
            if (typeof pdfjsLib !== 'undefined') {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.worker.min.js';
                pdfReady = true;
            }

            // æ£€æŸ¥ EPUB.js
            if (typeof ePub !== 'undefined') {
                epubReady = true;
            }

            // ç»‘å®šäº‹ä»¶
            setupEventListeners();
            
            // åŠ è½½ä¹¦æ¶
            loadBookList();
        }

        // çŠ¶æ€å˜é‡
        let currentBook = null;
        let pdfDoc = null;
        let epubBook = null;
        let epubRendition = null;
        let currentPage = 1;
        let totalPages = 1;
        let zoomScale = 1.0;

        // è·å–ä¹¦ç±åˆ—è¡¨
        function getBooks() {
            try {
                return JSON.parse(localStorage.getItem('ebook-library') || '[]');
            } catch (e) {
                return [];
            }
        }

        // ä¿å­˜ä¹¦ç±åˆ—è¡¨
        function saveBooks(books) {
            try {
                localStorage.setItem('ebook-library', JSON.stringify(books));
            } catch (e) {
                showError('ä¹¦ç±å¤ªå¤§ï¼Œæ— æ³•ä¿å­˜åˆ°ä¹¦æ¶');
            }
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬
        function setupEventListeners() {
            // æ–‡ä»¶é€‰æ‹©
            document.getElementById('file-input').addEventListener('change', handleFileSelect);

            // æ‹–æ”¾åŒºåŸŸ
            const dropZone = document.getElementById('drop-zone');
            dropZone.addEventListener('click', () => document.getElementById('file-input').click());
            
            // æ‹–æ”¾äº‹ä»¶
            document.body.addEventListener('dragover', (e) => e.preventDefault());
            document.body.addEventListener('drop', handleDrop);

            // ç¿»é¡µæŒ‰é’®
            document.getElementById('prev-btn').addEventListener('click', prevPage);
            document.getElementById('next-btn').addEventListener('click', nextPage);

            // ç¼©æ”¾æŒ‰é’®
            document.getElementById('zoom-in-btn').addEventListener('click', zoomIn);
            document.getElementById('zoom-out-btn').addEventListener('click', zoomOut);

            // é”®ç›˜å¿«æ·é”®
            document.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft') prevPage();
                if (e.key === 'ArrowRight') nextPage();
            });
        }

        // åŠ è½½ä¹¦æ¶åˆ—è¡¨
        function loadBookList() {
            const books = getBooks();
            const container = document.getElementById('book-list');
            
            if (books.length === 0) {
                container.innerHTML = '<p style="color: #a0a0a0; text-align: center;">ä¹¦æ¶ç©ºç©ºå¦‚ä¹Ÿ~<br>å¿«æ·»åŠ ä¸€æœ¬ä¹¦å§ï¼</p>';
                return;
            }

            container.innerHTML = books.map((book, index) => `
                <div class="book-item" data-index="${index}">
                    <button class="book-item-delete" data-index="${index}">Ã—</button>
                    <div class="book-item-title">${book.type === 'pdf' ? 'ğŸ“„' : 'ğŸ“•'} ${book.name}</div>
                    <div class="book-item-info">ä¸Šæ¬¡: ç¬¬ ${book.lastPage || 1} é¡µ</div>
                </div>
            `).join('');

            // ç»‘å®šç‚¹å‡»äº‹ä»¶
            container.querySelectorAll('.book-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('book-item-delete')) {
                        const index = parseInt(item.dataset.index);
                        openBookFromLibrary(index);
                    }
                });
            });

            // ç»‘å®šåˆ é™¤äº‹ä»¶
            container.querySelectorAll('.book-item-delete').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const index = parseInt(btn.dataset.index);
                    deleteBook(index);
                });
            });
        }

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) processFile(file);
        }

        // å¤„ç†æ‹–æ”¾
        function handleDrop(e) {
            e.preventDefault();
            const file = e.dataTransfer.files[0];
            if (file) processFile(file);
        }

        // å¤„ç†æ–‡ä»¶
        async function processFile(file) {
            const ext = file.name.split('.').pop().toLowerCase();
            
            if (ext === 'pdf' && !pdfReady) {
                showError('PDF åº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return;
            }
            
            if (ext === 'epub' && !epubReady) {
                showError('EPUB åº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return;
            }
            
            if (!['pdf', 'epub'].includes(ext)) {
                showError('åªæ”¯æŒ PDF å’Œ EPUB æ ¼å¼ï¼');
                return;
            }

            showLoading();

            try {
                const arrayBuffer = await file.arrayBuffer();
                
                // å…ˆå¤åˆ¶ä¸€ä»½ç”¨äºä¿å­˜ï¼ˆå› ä¸º PDF.js/EPUB.js ä¼šåˆ†ç¦»åŸå§‹ bufferï¼‰
                const bufferCopy = arrayBuffer.slice(0);
                
                // åˆ›å»ºä¹¦ç±æ•°æ®
                const bookData = {
                    name: file.name,
                    type: ext,
                    lastPage: 1
                };

                // æ‰“å¼€ä¹¦ç±ï¼ˆä½¿ç”¨åŸå§‹ bufferï¼‰
                if (ext === 'pdf') {
                    await openPDF(arrayBuffer);
                } else {
                    await openEPUB(arrayBuffer);
                }

                currentBook = bookData;
                
                // å°è¯•ä¿å­˜åˆ°ä¹¦æ¶ï¼ˆå°æ–‡ä»¶ï¼Œä½¿ç”¨å¤åˆ¶çš„ bufferï¼‰
                if (bufferCopy.byteLength < 5 * 1024 * 1024) { // < 5MB
                    const books = getBooks();
                    const existingIndex = books.findIndex(b => b.name === file.name);
                    
                    bookData.data = Array.from(new Uint8Array(bufferCopy));
                    
                    if (existingIndex >= 0) {
                        books[existingIndex] = bookData;
                    } else {
                        books.push(bookData);
                    }
                    
                    saveBooks(books);
                    loadBookList();
                }

                // æ˜¾ç¤ºé˜…è¯»ç•Œé¢
                showReader();
                
            } catch (error) {
                console.error('åŠ è½½å¤±è´¥:', error);
                showError('æ–‡ä»¶åŠ è½½å¤±è´¥: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // ä»ä¹¦æ¶æ‰“å¼€
        async function openBookFromLibrary(index) {
            const books = getBooks();
            const book = books[index];
            
            if (!book || !book.data) {
                showError('ä¹¦ç±æ•°æ®ä¸¢å¤±ï¼Œè¯·é‡æ–°æ·»åŠ ');
                return;
            }

            showLoading();

            try {
                const arrayBuffer = new Uint8Array(book.data).buffer;
                
                if (book.type === 'pdf') {
                    await openPDF(arrayBuffer, book.lastPage || 1);
                } else {
                    await openEPUB(arrayBuffer);
                }

                currentBook = book;
                currentBook.index = index;
                showReader();
                
            } catch (error) {
                showError('æ‰“å¼€å¤±è´¥: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // åˆ é™¤ä¹¦ç±
        function deleteBook(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æœ¬ä¹¦å—ï¼Ÿ')) {
                const books = getBooks();
                books.splice(index, 1);
                saveBooks(books);
                loadBookList();
            }
        }

        // æ‰“å¼€ PDF
        async function openPDF(arrayBuffer, startPage = 1) {
            document.getElementById('pdf-canvas').style.display = 'block';
            document.getElementById('epub-view').style.display = 'none';

            pdfDoc = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            totalPages = pdfDoc.numPages;
            currentPage = Math.min(startPage, totalPages);

            await renderPDFPage(currentPage);
        }

        // æ¸²æŸ“ PDF é¡µé¢
        async function renderPDFPage(pageNum) {
            if (!pdfDoc) return;
            
            const page = await pdfDoc.getPage(pageNum);
            const canvas = document.getElementById('pdf-canvas');
            const ctx = canvas.getContext('2d');

            const viewport = page.getViewport({ scale: zoomScale * 1.5 });
            canvas.width = viewport.width;
            canvas.height = viewport.height;

            await page.render({
                canvasContext: ctx,
                viewport: viewport
            }).promise;

            updatePageInfo();
            saveProgress();
        }

        // æ‰“å¼€ EPUB
        async function openEPUB(arrayBuffer) {
            document.getElementById('pdf-canvas').style.display = 'none';
            document.getElementById('epub-view').style.display = 'block';

            if (epubBook) {
                epubBook.destroy();
            }

            epubBook = ePub(arrayBuffer);
            epubRendition = epubBook.renderTo('epub-view', {
                width: '100%',
                height: '100%',
                spread: 'none'
            });

            await epubRendition.display();
            
            totalPages = 1;
            currentPage = 1;
            updatePageInfo();

            epubRendition.on('relocated', (location) => {
                if (location.start && location.start.displayed) {
                    currentPage = location.start.displayed.page || 1;
                    totalPages = location.start.displayed.total || 1;
                    updatePageInfo();
                }
            });
        }

        // æ˜¾ç¤ºé˜…è¯»ç•Œé¢
        function showReader() {
            document.getElementById('welcome-screen').classList.add('hidden');
            document.getElementById('reader-toolbar').classList.add('active');
            document.getElementById('reader-view').classList.add('active');
        }

        // ä¸Šä¸€é¡µ
        function prevPage() {
            if (pdfDoc && currentPage > 1) {
                currentPage--;
                renderPDFPage(currentPage);
            } else if (epubRendition) {
                epubRendition.prev();
            }
        }

        // ä¸‹ä¸€é¡µ
        function nextPage() {
            if (pdfDoc && currentPage < totalPages) {
                currentPage++;
                renderPDFPage(currentPage);
            } else if (epubRendition) {
                epubRendition.next();
            }
        }

        // ç¼©æ”¾
        function zoomIn() {
            zoomScale = Math.min(zoomScale + 0.2, 3.0);
            updateZoom();
        }

        function zoomOut() {
            zoomScale = Math.max(zoomScale - 0.2, 0.5);
            updateZoom();
        }

        function updateZoom() {
            document.getElementById('zoom-level').textContent = Math.round(zoomScale * 100) + '%';
            if (pdfDoc) {
                renderPDFPage(currentPage);
            }
        }

        // æ›´æ–°é¡µç 
        function updatePageInfo() {
            document.getElementById('page-info').textContent = `ç¬¬ ${currentPage} é¡µ / å…± ${totalPages} é¡µ`;
        }

        // ä¿å­˜è¿›åº¦
        function saveProgress() {
            if (currentBook && currentBook.index !== undefined) {
                const books = getBooks();
                if (books[currentBook.index]) {
                    books[currentBook.index].lastPage = currentPage;
                    saveBooks(books);
                }
            }
        }

        // æ˜¾ç¤º/éšè—åŠ è½½
        function showLoading() {
            document.getElementById('loading').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loading').classList.remove('active');
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(msg) {
            const el = document.getElementById('error-msg');
            el.textContent = msg;
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 5000);
        }
    </script>
</body>
</html>
