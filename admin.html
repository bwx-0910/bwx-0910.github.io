<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬”è®°ç®¡ç†åå°</title>
    <!-- ç½‘ç«™å›¾æ ‡ -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>âœï¸</text></svg>">
    
    <!-- Quill.js å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f5f7fa;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .setup-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .setup-section h2 {
            color: #333;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group textarea {
            min-height: 400px;
            font-family: 'Courier New', monospace;
            resize: vertical;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            margin-left: 10px;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .note-list {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .note-item {
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .note-item:hover {
            border-color: #667eea;
            background: #f9f9ff;
        }

        .note-info {
            flex: 1;
        }

        .note-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .note-meta {
            font-size: 12px;
            color: #666;
        }

        .note-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 6px 15px;
            font-size: 12px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-info {
            background: #e7f3ff;
            color: #0066cc;
            border: 1px solid #b3d9ff;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .code-block {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
            margin: 10px 0;
        }

        .editor-section {
            display: none;
        }

        .editor-section.active {
            display: block;
        }

        /* å†…å®¹åˆ‡æ¢æ ‡ç­¾ */
        .content-tabs {
            background: white;
            padding: 15px 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            gap: 10px;
        }

        .content-tabs .tab-btn {
            padding: 10px 20px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .content-tabs .tab-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .content-tabs .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }

        .content-panel {
            display: none;
        }

        .content-panel.active {
            display: block;
        }

        .preview {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-top: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ ç¬”è®°ç®¡ç†åå°</h1>
            <p>åœ¨çº¿ç¼–è¾‘å’Œç®¡ç†ä½ çš„è¯»ä¹¦ç¬”è®°</p>
        </div>

        <!-- GitHub è®¾ç½® -->
        <div class="setup-section" id="setupSection">
            <h2>âš™ï¸ GitHub é…ç½®</h2>
            
            <div class="alert alert-info">
                <strong>é¦–æ¬¡ä½¿ç”¨éœ€è¦é…ç½®</strong><br>
                éœ€è¦åˆ›å»ºä¸€ä¸ª GitHub Personal Access Token æ‰èƒ½åœ¨çº¿ç¼–è¾‘ç¬”è®°ã€‚
            </div>

            <div class="form-group">
                <label>GitHub ç”¨æˆ·å</label>
                <input type="text" id="githubUsername" value="bwx-0910" placeholder="ä½ çš„ GitHub ç”¨æˆ·å">
            </div>

            <div class="form-group">
                <label>ä»“åº“åç§°</label>
                <input type="text" id="repoName" value="bwx-0910.github.io" placeholder="ä»“åº“å">
            </div>

            <div class="form-group">
                <label>Personal Access Token</label>
                <input type="password" id="githubToken" placeholder="è¾“å…¥ä½ çš„ GitHub Token">
                <small style="color: #666; margin-top: 5px; display: block;">
                    <a href="https://github.com/settings/tokens/new?scopes=repo&description=Blog%20Editor" target="_blank">
                        ç‚¹å‡»è¿™é‡Œç”Ÿæˆ Token
                    </a>ï¼ˆéœ€è¦å‹¾é€‰ repo æƒé™ï¼‰
                </small>
            </div>

            <button class="btn btn-primary" onclick="saveConfig()">ä¿å­˜é…ç½®</button>
            
            <div style="margin-top: 20px;">
                <h3>å¦‚ä½•è·å– Tokenï¼Ÿ</h3>
                <ol style="color: #666; line-height: 1.8; margin-left: 20px;">
                    <li>è®¿é—® <a href="https://github.com/settings/tokens" target="_blank">GitHub Settings â†’ Tokens</a></li>
                    <li>ç‚¹å‡» "Generate new token (classic)"</li>
                    <li>å‹¾é€‰ <strong>repo</strong> æƒé™</li>
                    <li>ç”Ÿæˆå¹¶å¤åˆ¶ Token</li>
                    <li>ç²˜è´´åˆ°ä¸Šé¢çš„è¾“å…¥æ¡†</li>
                </ol>
            </div>
        </div>

        <!-- å†…å®¹åˆ‡æ¢æ ‡ç­¾ -->
        <div class="content-tabs" id="contentTabs" style="display: none;">
            <button class="tab-btn active" onclick="switchContent('notes')">ğŸ“š è¯»ä¹¦ç¬”è®°</button>
            <button class="tab-btn" onclick="switchContent('poems')">ğŸ“œ æ‘˜å½•</button>
        </div>

        <!-- ç¬”è®°åˆ—è¡¨ -->
        <div class="note-list content-panel active" id="noteList" style="display: none;">
            <h2>ğŸ“š æˆ‘çš„ç¬”è®°</h2>
            <button class="btn btn-primary" onclick="showEditor()">+ æ–°å»ºç¬”è®°</button>
            <div id="noteListContent" style="margin-top: 20px;"></div>
        </div>

        <!-- è¯—å¥åˆ—è¡¨ -->
        <div class="note-list content-panel" id="poemList" style="display: none;">
            <h2>ğŸ“œ æ‘˜å½•</h2>
            <button class="btn btn-primary" onclick="showPoemEditor()">+ æ·»åŠ è¯—å¥</button>
            <div id="poemListContent" style="margin-top: 20px;"></div>
        </div>

        <!-- è¯—å¥ç¼–è¾‘å™¨ -->
        <div class="editor-section" id="poemEditorSection">
            <div class="setup-section">
                <h2 id="poemEditorTitle">âœï¸ æ·»åŠ è¯—å¥</h2>

                <div class="form-group">
                    <label>è¯—å¥å†…å®¹</label>
                    <textarea id="poemContent" rows="5" placeholder="ä¸¾å¤´æœ›æ˜æœˆï¼Œä½å¤´æ€æ•…ä¹¡"></textarea>
                </div>

                <div class="form-group">
                    <label>å‡ºå¤„</label>
                    <input type="text" id="poemSource" placeholder="é™å¤œæ€">
                </div>

                <div class="form-group">
                    <label>
                        é…å›¾ï¼ˆå¯é€‰ï¼‰
                        <span style="color: #999; font-size: 12px; font-weight: normal;">
                            ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡
                        </span>
                    </label>
                    <div id="poemImageUpload" style="border: 2px dashed #ddd; padding: 20px; text-align: center; border-radius: 8px; cursor: pointer; transition: all 0.3s;">
                        <span id="poemImagePlaceholder">ğŸ“· ç‚¹å‡»é€‰æ‹©å›¾ç‰‡</span>
                        <img id="poemImagePreview" style="max-width: 100%; max-height: 300px; display: none; margin-top: 10px; border-radius: 8px;">
                        <input type="file" id="poemImageInput" accept="image/*" style="display: none;">
                        <input type="hidden" id="poemImageUrl">
                    </div>
                </div>

                <div>
                    <button class="btn btn-primary" onclick="savePoem()">ğŸ’¾ ä¿å­˜è¯—å¥</button>
                    <button class="btn btn-secondary" onclick="cancelPoemEdit()">å–æ¶ˆ</button>
                </div>
            </div>
        </div>

        <!-- ç¬”è®°ç¼–è¾‘å™¨ -->
        <div class="editor-section" id="editorSection">
            <div class="setup-section">
                <h2 id="editorTitle">âœï¸ ç¼–è¾‘ç¬”è®°</h2>

                <div class="form-group">
                    <label>æ ‡é¢˜</label>
                    <input type="text" id="noteTitle" placeholder="ã€Šä¹¦åã€‹è¯»ä¹¦ç¬”è®°">
                </div>

                <div class="form-group">
                    <label>å›¾æ ‡ Emoji</label>
                    <input type="text" id="noteIcon" value="ğŸ“–" maxlength="2">
                </div>

                <div class="form-group">
                    <label>åˆ†ç±»</label>
                    <input type="text" id="noteCategory" placeholder="å¦‚ï¼šå¿ƒç†å­¦ã€å†å²ã€å•†ä¸š">
                </div>

                <div class="form-group">
                    <label>æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
                    <input type="text" id="noteTags" placeholder="æ ‡ç­¾1, æ ‡ç­¾2, æ ‡ç­¾3">
                </div>

                <div class="form-group">
                    <label>æ‘˜è¦</label>
                    <textarea id="noteExcerpt" rows="3" placeholder="ç®€çŸ­çš„æ‘˜è¦ï¼Œ100-200å­—..."></textarea>
                </div>

                <!-- ä¹¦ç±æ‘˜å½•åŒºåŸŸ -->
                <div class="form-group">
                    <label>
                        ğŸ“Œ ä¹¦ç±æ‘˜å½•
                        <span style="color: #999; font-size: 12px; font-weight: normal;">
                            è®°å½•ä¹¦ä¸­çš„ç²¾å½©æ®µè½å’Œé‡‘å¥
                        </span>
                    </label>
                    <div id="quotesContainer" style="margin-bottom: 10px;">
                        <!-- æ‘˜å½•åˆ—è¡¨å°†åŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <textarea id="newQuoteInput" rows="3" placeholder="è¾“å…¥ä¸€æ¡æ‘˜å½•..." style="flex: 1;"></textarea>
                        <button type="button" class="btn btn-primary" onclick="addQuote()" style="height: fit-content;">+ æ·»åŠ æ‘˜å½•</button>
                    </div>
                </div>

                <div class="form-group">
                    <label>
                        ç¬”è®°å†…å®¹ï¼ˆå¯Œæ–‡æœ¬ç¼–è¾‘ï¼‰
                        <span style="color: #999; font-size: 12px; font-weight: normal;">
                            æ”¯æŒåŠ ç²—ã€æ–œä½“ã€å¼•ç”¨ã€åˆ—è¡¨ç­‰æ ¼å¼
                        </span>
                    </label>
                    <!-- Quill å¯Œæ–‡æœ¬ç¼–è¾‘å™¨å®¹å™¨ -->
                    <div id="editor" style="background: white; min-height: 400px; border: 1px solid #ddd; border-radius: 8px;"></div>
                    <!-- éšè—çš„ textarea ç”¨äºå­˜å‚¨ Markdown -->
                    <textarea id="noteContent" style="display: none;"></textarea>
                </div>

                <div>
                    <button class="btn btn-primary" onclick="saveNote()">ğŸ’¾ ä¿å­˜ç¬”è®°</button>
                    <button class="btn btn-secondary" onclick="cancelEdit()">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentEditFile = null;
        let currentEditPoem = null;
        let quill = null; // Quill ç¼–è¾‘å™¨å®ä¾‹
        let quotes = []; // å­˜å‚¨ä¹¦ç±æ‘˜å½•

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            initQuillEditor();
            loadConfig();
        });

        // åˆå§‹åŒ– Quill å¯Œæ–‡æœ¬ç¼–è¾‘å™¨
        function initQuillEditor() {
            quill = new Quill('#editor', {
                theme: 'snow',
                placeholder: 'å¼€å§‹å†™ç¬”è®°å§...\n\nğŸ’¡ æç¤ºï¼šå¯ä»¥ç›´æ¥ç²˜è´´å›¾ç‰‡ï¼ˆCtrl+Vï¼‰',
                modules: {
                    toolbar: [
                        // æ ¼å¼åŒ–
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        
                        // å¼•ç”¨å’Œä»£ç ï¼ˆé€‚åˆæ‘˜å½•ï¼‰
                        ['blockquote', 'code-block'],
                        
                        // åˆ—è¡¨
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        
                        // å›¾ç‰‡å’Œé“¾æ¥
                        ['image', 'link'],
                        
                        // é¢œè‰²å’ŒèƒŒæ™¯ï¼ˆçªå‡ºé‡ç‚¹ï¼‰
                        [{ 'color': [] }, { 'background': [] }],
                        
                        // å¯¹é½æ–¹å¼
                        [{ 'align': [] }],
                        
                        // æ¸…é™¤æ ¼å¼
                        ['clean']
                    ]
                }
            });

            // ç›‘å¬ç²˜è´´äº‹ä»¶
            const editor = document.querySelector('#editor .ql-editor');
            editor.addEventListener('paste', handlePaste, false);

            // è¦†ç›–å›¾ç‰‡æŒ‰é’®çš„é»˜è®¤è¡Œä¸º
            const toolbar = quill.getModule('toolbar');
            toolbar.addHandler('image', selectLocalImage);

            // æ·»åŠ è‡ªå®šä¹‰æ ·å¼è®©å¼•ç”¨æ›´ç¾è§‚
            const style = document.createElement('style');
            style.textContent = `
                .ql-editor blockquote {
                    background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
                    border-left: 5px solid #e17055;
                    padding: 15px 20px;
                    margin: 20px 0;
                    border-radius: 8px;
                    font-style: italic;
                    color: #2d3436;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                }
                .ql-editor {
                    font-size: 16px;
                    line-height: 1.8;
                    min-height: 400px;
                }
                .ql-editor strong {
                    color: #e74c3c;
                    font-weight: 700;
                }
                .ql-editor em {
                    color: #3498db;
                }
            `;
            document.head.appendChild(style);
        }

        // å°† Quill å†…å®¹è½¬æ¢ä¸º Markdown
        function quillToMarkdown() {
            const delta = quill.getContents();
            const html = quill.root.innerHTML;
            
            // ç®€å•çš„ HTML åˆ° Markdown è½¬æ¢
            let markdown = html;
            
            // æ ‡é¢˜
            markdown = markdown.replace(/<h1>(.*?)<\/h1>/g, '# $1\n\n');
            markdown = markdown.replace(/<h2>(.*?)<\/h2>/g, '## $1\n\n');
            markdown = markdown.replace(/<h3>(.*?)<\/h3>/g, '### $1\n\n');
            
            // æ ¼å¼åŒ–
            markdown = markdown.replace(/<strong>(.*?)<\/strong>/g, '**$1**');
            markdown = markdown.replace(/<em>(.*?)<\/em>/g, '*$1*');
            markdown = markdown.replace(/<u>(.*?)<\/u>/g, '_$1_');
            markdown = markdown.replace(/<s>(.*?)<\/s>/g, '~~$1~~');
            
            // å¼•ç”¨ï¼ˆé‡ç‚¹ï¼šæ‘˜å½•å¥å­ï¼‰
            markdown = markdown.replace(/<blockquote>(.*?)<\/blockquote>/gs, function(match, content) {
                return '\n> ' + content.replace(/<[^>]*>/g, '').trim() + '\n\n';
            });
            
            // åˆ—è¡¨
            markdown = markdown.replace(/<ul>(.*?)<\/ul>/gs, function(match, content) {
                return content.replace(/<li>(.*?)<\/li>/g, '- $1\n');
            });
            markdown = markdown.replace(/<ol>(.*?)<\/ol>/gs, function(match, content) {
                let index = 1;
                return content.replace(/<li>(.*?)<\/li>/g, function(m, item) {
                    return `${index++}. ${item}\n`;
                });
            });
            
            // æ®µè½
            markdown = markdown.replace(/<p>(.*?)<\/p>/g, '$1\n\n');
            
            // æ¸…ç† HTML æ ‡ç­¾
            markdown = markdown.replace(/<[^>]*>/g, '');
            
            // æ¸…ç†å¤šä½™ç©ºè¡Œ
            markdown = markdown.replace(/\n{3,}/g, '\n\n');
            
            return markdown.trim();
        }

        // æ·»åŠ æ‘˜å½•
        function addQuote() {
            const input = document.getElementById('newQuoteInput');
            const text = input.value.trim();
            
            if (!text) {
                alert('è¯·è¾“å…¥æ‘˜å½•å†…å®¹');
                return;
            }
            
            quotes.push(text);
            input.value = '';
            renderQuotes();
        }

        // åˆ é™¤æ‘˜å½•
        function removeQuote(index) {
            quotes.splice(index, 1);
            renderQuotes();
        }

        // æ¸²æŸ“æ‘˜å½•åˆ—è¡¨
        function renderQuotes() {
            const container = document.getElementById('quotesContainer');
            
            if (quotes.length === 0) {
                container.innerHTML = '<p style="color: #999; font-size: 14px; padding: 10px;">æš‚æ— æ‘˜å½•ï¼Œç‚¹å‡»ä¸‹æ–¹æ·»åŠ </p>';
                return;
            }
            
            container.innerHTML = quotes.map((quote, index) => `
                <div class="quote-item">
                    <div class="quote-text">"${quote}"</div>
                    <button type="button" class="quote-delete" onclick="removeQuote(${index})">åˆ é™¤</button>
                </div>
            `).join('');
        }

        // å°† Markdown è½¬æ¢ä¸º Quill HTML
        function markdownToQuill(markdown) {
            if (!markdown) return '';
            
            let html = markdown;
            
            // æ ‡é¢˜
            html = html.replace(/^### (.*?)$/gm, '<h3>$1</h3>');
            html = html.replace(/^## (.*?)$/gm, '<h2>$1</h2>');
            html = html.replace(/^# (.*?)$/gm, '<h1>$1</h1>');
            
            // å¼•ç”¨
            html = html.replace(/^> (.*?)$/gm, '<blockquote>$1</blockquote>');
            
            // åŠ ç²—
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // æ–œä½“
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // åˆ é™¤çº¿
            html = html.replace(/~~(.*?)~~/g, '<s>$1</s>');
            
            // åˆ—è¡¨ï¼ˆç®€å•å¤„ç†ï¼‰
            html = html.replace(/^- (.*?)$/gm, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
            
            // æ®µè½
            html = html.replace(/^(?!<[hbu]|<li)(.*?)$/gm, '<p>$1</p>');
            
            return html;
        }

        // åŠ è½½é…ç½®
        function loadConfig() {
            const config = localStorage.getItem('githubConfig');
            if (config) {
                const data = JSON.parse(config);
                document.getElementById('githubUsername').value = data.username || 'bwx-0910';
                document.getElementById('repoName').value = data.repo || 'bwx-0910.github.io';
                document.getElementById('githubToken').value = data.token || '';
                
                if (data.token) {
                    document.getElementById('setupSection').style.display = 'none';
                    document.getElementById('contentTabs').style.display = 'flex';
                    document.getElementById('noteList').style.display = 'block';
                    loadNotes();
                }
            }
        }

        // åˆ‡æ¢å†…å®¹é¢æ¿
        function switchContent(type) {
            // æ›´æ–°æ ‡ç­¾çŠ¶æ€
            document.querySelectorAll('.content-tabs .tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // åˆ‡æ¢é¢æ¿
            if (type === 'notes') {
                document.getElementById('noteList').classList.add('active');
                document.getElementById('poemList').classList.remove('active');
                document.getElementById('noteList').style.display = 'block';
                document.getElementById('poemList').style.display = 'none';
            } else if (type === 'poems') {
                document.getElementById('poemList').classList.add('active');
                document.getElementById('noteList').classList.remove('active');
                document.getElementById('poemList').style.display = 'block';
                document.getElementById('noteList').style.display = 'none';
                loadPoems();
            }
        }

        // ä¿å­˜é…ç½®
        function saveConfig() {
            const username = document.getElementById('githubUsername').value;
            const repo = document.getElementById('repoName').value;
            const token = document.getElementById('githubToken').value;

            if (!username || !repo || !token) {
                alert('è¯·å¡«å†™æ‰€æœ‰å­—æ®µ');
                return;
            }

            localStorage.setItem('githubConfig', JSON.stringify({
                username: username,
                repo: repo,
                token: token
            }));

            alert('é…ç½®å·²ä¿å­˜ï¼');
            document.getElementById('setupSection').style.display = 'none';
            document.getElementById('contentTabs').style.display = 'flex';
            document.getElementById('noteList').style.display = 'block';
            loadNotes();
        }

        // åŠ è½½ç¬”è®°åˆ—è¡¨
        async function loadNotes() {
            const config = JSON.parse(localStorage.getItem('githubConfig'));
            const url = `https://api.github.com/repos/${config.username}/${config.repo}/contents/notes`;

            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `token ${config.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!response.ok) {
                    throw new Error('æ— æ³•åŠ è½½ç¬”è®°åˆ—è¡¨');
                }

                const files = await response.json();
                const mdFiles = files.filter(f => 
                    f.name.endsWith('.md') && 
                    f.name !== 'ç¬”è®°æ¨¡æ¿.md' && 
                    f.name !== 'README.md'
                );

                displayNotes(mdFiles);
            } catch (error) {
                alert('åŠ è½½å¤±è´¥ï¼š' + error.message);
                console.error(error);
            }
        }

        // æ˜¾ç¤ºç¬”è®°åˆ—è¡¨
        function displayNotes(files) {
            const container = document.getElementById('noteListContent');
            
            if (files.length === 0) {
                container.innerHTML = '<p style="color: #666; padding: 20px;">è¿˜æ²¡æœ‰ç¬”è®°ï¼Œç‚¹å‡»ä¸Šé¢çš„æŒ‰é’®åˆ›å»ºç¬¬ä¸€ç¯‡ç¬”è®°å§ï¼</p>';
                return;
            }

            container.innerHTML = files.map(file => `
                <div class="note-item">
                    <div class="note-info">
                        <div class="note-title">${file.name.replace('.md', '')}</div>
                        <div class="note-meta">æ–‡ä»¶å: ${file.name}</div>
                    </div>
                    <div class="note-actions">
                        <button class="btn btn-primary btn-small" onclick="editNote('${file.name}')">ç¼–è¾‘</button>
                        <button class="btn btn-small" style="background: #dc3545; color: white;" onclick="deleteNote('${file.name}', event)">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        // æ˜¾ç¤ºç¼–è¾‘å™¨
        function showEditor() {
            document.getElementById('editorSection').classList.add('active');
            document.getElementById('noteList').style.display = 'none';
            document.getElementById('editorTitle').textContent = 'âœï¸ æ–°å»ºç¬”è®°';
            
            // æ¸…ç©ºè¡¨å•
            document.getElementById('noteTitle').value = '';
            document.getElementById('noteIcon').value = 'ğŸ“–';
            document.getElementById('noteCategory').value = '';
            document.getElementById('noteTags').value = '';
            document.getElementById('noteExcerpt').value = '';
            
            // æ¸…ç©ºæ‘˜å½•
            quotes = [];
            renderQuotes();
            
            // æ¸…ç©º Quill ç¼–è¾‘å™¨
            quill.setText('');
            
            currentEditFile = null;
        }

        // ç¼–è¾‘ç¬”è®°
        async function editNote(filename) {
            const config = JSON.parse(localStorage.getItem('githubConfig'));
            const url = `https://api.github.com/repos/${config.username}/${config.repo}/contents/notes/${filename}`;

            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `token ${config.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                const file = await response.json();
                // æ­£ç¡®è§£ç  UTF-8 ä¸­æ–‡å†…å®¹
                const content = decodeURIComponent(escape(atob(file.content)));
                
                // è§£æ Front Matter
                const match = content.match(/^---\n([\s\S]*?)\n---\n([\s\S]*)$/);
                if (match) {
                    const frontmatter = match[1];
                    const body = match[2];
                    
                    // è§£æå„ä¸ªå­—æ®µ
                    const title = frontmatter.match(/title:\s*(.+)/)?.[1] || '';
                    const icon = frontmatter.match(/icon:\s*(.+)/)?.[1] || 'ğŸ“–';
                    const category = frontmatter.match(/category:\s*(.+)/)?.[1] || '';
                    const tags = frontmatter.match(/tags:\s*(.+)/)?.[1] || '';
                    const excerpt = frontmatter.match(/excerpt:\s*(.+)/)?.[1] || '';
                    
                    // è§£ææ‘˜å½•æ•°ç»„
                    const quotesMatch = frontmatter.match(/quotes:\s*(\[[\s\S]*?\])/);
                    if (quotesMatch) {
                        try {
                            quotes = JSON.parse(quotesMatch[1]);
                        } catch (e) {
                            console.error('è§£ææ‘˜å½•å¤±è´¥:', e);
                            quotes = [];
                        }
                    } else {
                        quotes = [];
                    }
                    
                    document.getElementById('noteTitle').value = title;
                    document.getElementById('noteIcon').value = icon;
                    document.getElementById('noteCategory').value = category;
                    document.getElementById('noteTags').value = tags;
                    document.getElementById('noteExcerpt').value = excerpt;
                    
                    // æ¸²æŸ“æ‘˜å½•åˆ—è¡¨
                    renderQuotes();
                    
                    // å°† Markdown å†…å®¹åŠ è½½åˆ° Quill ç¼–è¾‘å™¨
                    const html = markdownToQuill(body.trim());
                    quill.root.innerHTML = html;
                }
                
                currentEditFile = {
                    name: filename,
                    sha: file.sha
                };
                
                document.getElementById('editorSection').classList.add('active');
                document.getElementById('noteList').style.display = 'none';
                document.getElementById('editorTitle').textContent = 'âœï¸ ç¼–è¾‘ç¬”è®°: ' + filename;
                
            } catch (error) {
                alert('åŠ è½½ç¬”è®°å¤±è´¥ï¼š' + error.message);
            }
        }

        // ä¿å­˜ç¬”è®°
        async function saveNote() {
            const title = document.getElementById('noteTitle').value;
            const icon = document.getElementById('noteIcon').value;
            const category = document.getElementById('noteCategory').value;
            const tags = document.getElementById('noteTags').value;
            const excerpt = document.getElementById('noteExcerpt').value;
            
            // ä» Quill ç¼–è¾‘å™¨è·å–å†…å®¹å¹¶è½¬æ¢ä¸º Markdown
            const content = quillToMarkdown();

            if (!title || !content) {
                alert('è¯·è‡³å°‘å¡«å†™æ ‡é¢˜å’Œå†…å®¹');
                return;
            }

            // ç”Ÿæˆå®Œæ•´çš„ Markdown å†…å®¹
            const today = new Date().toISOString().split('T')[0];
            const quotesJson = JSON.stringify(quotes);
            const fullContent = `---
title: ${title}
icon: ${icon}
date: ${today}
category: ${category}
tags: ${tags}
excerpt: ${excerpt}
quotes: ${quotesJson}
---

${content}`;

            // ç”Ÿæˆæ–‡ä»¶å
            const filename = currentEditFile ? currentEditFile.name : 
                            (title.replace(/[ã€Šã€‹]/g, '').replace(/\s+/g, '-') + '.md');

            const config = JSON.parse(localStorage.getItem('githubConfig'));
            const url = `https://api.github.com/repos/${config.username}/${config.repo}/contents/notes/${filename}`;

            try {
                const data = {
                    message: currentEditFile ? `æ›´æ–°ç¬”è®°: ${filename}` : `æ–°å»ºç¬”è®°: ${filename}`,
                    content: btoa(unescape(encodeURIComponent(fullContent))),
                    branch: 'main'
                };

                if (currentEditFile) {
                    data.sha = currentEditFile.sha;
                }

                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${config.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error('ä¿å­˜å¤±è´¥');
                }

                alert('âœ… ä¿å­˜æˆåŠŸï¼\n\nè¯·ç­‰å¾… 1-2 åˆ†é’Ÿè®© GitHub Pages æ„å»ºå®Œæˆã€‚');
                cancelEdit();
                loadNotes();
                
            } catch (error) {
                alert('ä¿å­˜å¤±è´¥ï¼š' + error.message);
                console.error(error);
            }
        }

        // åˆ é™¤ç¬”è®°
        async function deleteNote(filename, event) {
            event.stopPropagation(); // é˜²æ­¢è§¦å‘çˆ¶å…ƒç´ çš„ç‚¹å‡»äº‹ä»¶
            
            if (!confirm(`ç¡®å®šè¦åˆ é™¤"${filename}"å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                return;
            }

            const config = JSON.parse(localStorage.getItem('githubConfig'));
            const url = `https://api.github.com/repos/${config.username}/${config.repo}/contents/notes/${filename}`;

            try {
                // é¦–å…ˆè·å–æ–‡ä»¶ä¿¡æ¯ä»¥è·å¾— sha
                const getResponse = await fetch(url, {
                    headers: {
                        'Authorization': `token ${config.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!getResponse.ok) {
                    throw new Error('æ— æ³•è·å–æ–‡ä»¶ä¿¡æ¯');
                }

                const fileInfo = await getResponse.json();

                // åˆ é™¤æ–‡ä»¶
                const deleteResponse = await fetch(url, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `token ${config.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `åˆ é™¤ç¬”è®°: ${filename}`,
                        sha: fileInfo.sha,
                        branch: 'main'
                    })
                });

                if (!deleteResponse.ok) {
                    throw new Error('åˆ é™¤å¤±è´¥');
                }

                alert('âœ… åˆ é™¤æˆåŠŸï¼\n\nè¯·ç­‰å¾… 1-2 åˆ†é’Ÿè®©æ›´æ”¹ç”Ÿæ•ˆã€‚');
                loadNotes(); // é‡æ–°åŠ è½½åˆ—è¡¨
                
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥ï¼š' + error.message);
                console.error(error);
            }
        }

        // å–æ¶ˆç¼–è¾‘
        function cancelEdit() {
            document.getElementById('editorSection').classList.remove('active');
            document.getElementById('noteList').style.display = 'block';
            currentEditFile = null;
            
            // æ¸…ç©º Quill ç¼–è¾‘å™¨
            quill.setText('');
            
            // æ¸…ç©ºå…¶ä»–è¡¨å•å­—æ®µ
            document.getElementById('noteTitle').value = '';
            document.getElementById('noteIcon').value = 'ğŸ“–';
            document.getElementById('noteCategory').value = '';
            document.getElementById('noteTags').value = '';
            document.getElementById('noteExcerpt').value = '';
            
            // æ¸…ç©ºæ‘˜å½•
            quotes = [];
            renderQuotes();
        }

        // åŠ è½½è¯—å¥åˆ—è¡¨
        async function loadPoems() {
            const config = JSON.parse(localStorage.getItem('githubConfig'));
            const url = `https://api.github.com/repos/${config.username}/${config.repo}/contents/poems`;

            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `token ${config.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!response.ok) {
                    throw new Error('æ— æ³•åŠ è½½è¯—å¥åˆ—è¡¨');
                }

                const files = await response.json();
                const mdFiles = files.filter(f => 
                    f.name.endsWith('.md') && 
                    f.name !== 'è¯—è¯æ¨¡æ¿.md' && 
                    f.name !== 'README.md'
                );

                displayPoems(mdFiles);
            } catch (error) {
                alert('åŠ è½½å¤±è´¥ï¼š' + error.message);
                console.error(error);
            }
        }

        // æ˜¾ç¤ºè¯—å¥åˆ—è¡¨
        function displayPoems(files) {
            const container = document.getElementById('poemListContent');
            
            if (files.length === 0) {
                container.innerHTML = '<p style="color: #666; padding: 20px;">è¿˜æ²¡æœ‰è¯—å¥ï¼Œç‚¹å‡»ä¸Šé¢çš„æŒ‰é’®æ·»åŠ ç¬¬ä¸€æ¡è¯—å¥å§ï¼</p>';
                return;
            }

            container.innerHTML = files.map(file => `
                <div class="note-item">
                    <div class="note-info">
                        <div class="note-title">${file.name.replace('.md', '')}</div>
                        <div class="note-meta">æ–‡ä»¶å: ${file.name}</div>
                    </div>
                    <div class="note-actions">
                        <button class="btn btn-primary btn-small" onclick="editPoem('${file.name}')">ç¼–è¾‘</button>
                        <button class="btn btn-small" style="background: #dc3545; color: white;" onclick="deletePoem('${file.name}', event)">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        // æ˜¾ç¤ºè¯—å¥ç¼–è¾‘å™¨
        function showPoemEditor() {
            document.getElementById('poemEditorSection').classList.add('active');
            document.getElementById('poemList').style.display = 'none';
            document.getElementById('poemEditorTitle').textContent = 'âœï¸ æ·»åŠ è¯—å¥';
            
            document.getElementById('poemContent').value = '';
            document.getElementById('poemSource').value = '';
            document.getElementById('poemImageUrl').value = '';
            document.getElementById('poemImagePreview').style.display = 'none';
            document.getElementById('poemImagePlaceholder').style.display = 'inline';
            
            currentEditPoem = null;
        }

        // è¯—å¥å›¾ç‰‡ä¸Šä¼ å¤„ç†
        document.addEventListener('DOMContentLoaded', function() {
            const uploadArea = document.getElementById('poemImageUpload');
            const fileInput = document.getElementById('poemImageInput');
            const preview = document.getElementById('poemImagePreview');
            const placeholder = document.getElementById('poemImagePlaceholder');
            const imageUrlInput = document.getElementById('poemImageUrl');

            // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸ
            uploadArea.onclick = () => fileInput.click();

            // æ–‡ä»¶é€‰æ‹©
            fileInput.onchange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    await uploadPoemImage(file);
                }
            };

            // æ‹–æ‹½ä¸Šä¼ 
            uploadArea.ondragover = (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#667eea';
                uploadArea.style.background = '#f9f9ff';
            };

            uploadArea.ondragleave = (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#ddd';
                uploadArea.style.background = 'white';
            };

            uploadArea.ondrop = async (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#ddd';
                uploadArea.style.background = 'white';
                
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('image/')) {
                    await uploadPoemImage(file);
                }
            };
        });

        // ä¸Šä¼ è¯—å¥é…å›¾
        async function uploadPoemImage(file) {
            const config = JSON.parse(localStorage.getItem('githubConfig'));
            if (!config || !config.token) {
                alert('è¯·å…ˆé…ç½® GitHub');
                return;
            }

            const placeholder = document.getElementById('poemImagePlaceholder');
            const preview = document.getElementById('poemImagePreview');
            const imageUrlInput = document.getElementById('poemImageUrl');

            placeholder.textContent = 'ä¸Šä¼ ä¸­...';

            try {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const base64Data = e.target.result.split(',')[1];
                    const timestamp = Date.now();
                    const filename = `poem-${timestamp}-${file.name}`;
                    const url = `https://api.github.com/repos/${config.username}/${config.repo}/contents/images/${filename}`;

                    try {
                        const response = await fetch(url, {
                            method: 'PUT',
                            headers: {
                                'Authorization': `token ${config.token}`,
                                'Accept': 'application/vnd.github.v3+json',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                message: `ä¸Šä¼ è¯—å¥é…å›¾: ${filename}`,
                                content: base64Data,
                                branch: 'main'
                            })
                        });

                        if (!response.ok) {
                            throw new Error('ä¸Šä¼ å¤±è´¥');
                        }

                        const imageUrl = `https://raw.githubusercontent.com/${config.username}/${config.repo}/main/images/${filename}`;
                        
                        // æ˜¾ç¤ºé¢„è§ˆ
                        preview.src = imageUrl;
                        preview.style.display = 'block';
                        placeholder.style.display = 'none';
                        imageUrlInput.value = imageUrl;

                        console.log('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ:', imageUrl);
                    } catch (error) {
                        placeholder.textContent = 'ğŸ“· ä¸Šä¼ å¤±è´¥ï¼Œç‚¹å‡»é‡è¯•';
                        alert('å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼š' + error.message);
                    }
                };
                
                reader.readAsDataURL(file);
            } catch (error) {
                placeholder.textContent = 'ğŸ“· ç‚¹å‡»é€‰æ‹©å›¾ç‰‡';
                alert('è¯»å–å›¾ç‰‡å¤±è´¥ï¼š' + error.message);
            }
        }

        // ç¼–è¾‘è¯—å¥
        async function editPoem(filename) {
            const config = JSON.parse(localStorage.getItem('githubConfig'));
            const url = `https://api.github.com/repos/${config.username}/${config.repo}/contents/poems/${filename}`;

            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `token ${config.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                const file = await response.json();
                const content = decodeURIComponent(escape(atob(file.content)));
                
                // è§£æ Front Matter
                const match = content.match(/^---\n([\s\S]*?)\n---\n([\s\S]*)$/);
                if (match) {
                    const frontmatter = match[1];
                    const body = match[2];
                    
                    const source = frontmatter.match(/source:\s*(.+)/)?.[1] || '';
                    const image = frontmatter.match(/image:\s*(.+)/)?.[1] || '';
                    
                    document.getElementById('poemContent').value = body.trim();
                    document.getElementById('poemSource').value = source;
                    
                    if (image) {
                        document.getElementById('poemImageUrl').value = image;
                        document.getElementById('poemImagePreview').src = image;
                        document.getElementById('poemImagePreview').style.display = 'block';
                        document.getElementById('poemImagePlaceholder').style.display = 'none';
                    }
                }
                
                currentEditPoem = {
                    name: filename,
                    sha: file.sha
                };
                
                document.getElementById('poemEditorSection').classList.add('active');
                document.getElementById('poemList').style.display = 'none';
                document.getElementById('poemEditorTitle').textContent = 'âœï¸ ç¼–è¾‘è¯—å¥: ' + filename;
                
            } catch (error) {
                alert('åŠ è½½è¯—å¥å¤±è´¥ï¼š' + error.message);
            }
        }

        // ä¿å­˜è¯—å¥
        async function savePoem() {
            const content = document.getElementById('poemContent').value.trim();
            const source = document.getElementById('poemSource').value.trim();
            const imageUrl = document.getElementById('poemImageUrl').value.trim();

            if (!content || !source) {
                alert('è¯·å¡«å†™è¯—å¥å†…å®¹å’Œå‡ºå¤„');
                return;
            }

            const today = new Date().toISOString().split('T')[0];
            let fullContent = `---
source: ${source}
date: ${today}`;
            
            if (imageUrl) {
                fullContent += `\nimage: ${imageUrl}`;
            }
            
            fullContent += `\n---\n\n${content}`;

            const filename = currentEditPoem ? currentEditPoem.name : 
                            (source.replace(/[ã€Šã€‹]/g, '').replace(/\s+/g, '-') + '.md');

            const config = JSON.parse(localStorage.getItem('githubConfig'));
            const url = `https://api.github.com/repos/${config.username}/${config.repo}/contents/poems/${filename}`;

            try {
                const data = {
                    message: currentEditPoem ? `æ›´æ–°è¯—å¥: ${filename}` : `æ·»åŠ è¯—å¥: ${filename}`,
                    content: btoa(unescape(encodeURIComponent(fullContent))),
                    branch: 'main'
                };

                if (currentEditPoem) {
                    data.sha = currentEditPoem.sha;
                }

                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${config.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error('ä¿å­˜å¤±è´¥');
                }

                alert('âœ… ä¿å­˜æˆåŠŸï¼\n\nè¯·ç­‰å¾… 1-2 åˆ†é’Ÿè®© GitHub Pages æ„å»ºå®Œæˆã€‚');
                cancelPoemEdit();
                loadPoems();
                
            } catch (error) {
                alert('ä¿å­˜å¤±è´¥ï¼š' + error.message);
                console.error(error);
            }
        }

        // åˆ é™¤è¯—å¥
        async function deletePoem(filename, event) {
            event.stopPropagation();
            
            if (!confirm(`ç¡®å®šè¦åˆ é™¤"${filename}"å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                return;
            }

            const config = JSON.parse(localStorage.getItem('githubConfig'));
            const url = `https://api.github.com/repos/${config.username}/${config.repo}/contents/poems/${filename}`;

            try {
                const getResponse = await fetch(url, {
                    headers: {
                        'Authorization': `token ${config.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!getResponse.ok) {
                    throw new Error('æ— æ³•è·å–æ–‡ä»¶ä¿¡æ¯');
                }

                const fileInfo = await getResponse.json();

                const deleteResponse = await fetch(url, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `token ${config.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `åˆ é™¤è¯—å¥: ${filename}`,
                        sha: fileInfo.sha,
                        branch: 'main'
                    })
                });

                if (!deleteResponse.ok) {
                    throw new Error('åˆ é™¤å¤±è´¥');
                }

                alert('âœ… åˆ é™¤æˆåŠŸï¼');
                loadPoems();
                
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥ï¼š' + error.message);
                console.error(error);
            }
        }

        // å–æ¶ˆè¯—å¥ç¼–è¾‘
        function cancelPoemEdit() {
            document.getElementById('poemEditorSection').classList.remove('active');
            document.getElementById('poemList').style.display = 'block';
            currentEditPoem = null;
            
            document.getElementById('poemContent').value = '';
            document.getElementById('poemSource').value = '';
        }

        // å¤„ç†ç²˜è´´äº‹ä»¶ï¼ˆæ”¯æŒç²˜è´´å›¾ç‰‡ï¼‰
        function handlePaste(e) {
            const clipboardData = e.clipboardData || window.clipboardData;
            const items = clipboardData.items;

            if (!items) return;

            // æŸ¥æ‰¾å›¾ç‰‡
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    e.preventDefault();
                    const blob = items[i].getAsFile();
                    uploadImageToGitHub(blob);
                    return;
                }
            }
        }

        // é€‰æ‹©æœ¬åœ°å›¾ç‰‡ï¼ˆç‚¹å‡»å›¾ç‰‡æŒ‰é’®ï¼‰
        function selectLocalImage() {
            const input = document.createElement('input');
            input.setAttribute('type', 'file');
            input.setAttribute('accept', 'image/*');
            input.click();

            input.onchange = () => {
                const file = input.files[0];
                if (file) {
                    uploadImageToGitHub(file);
                }
            };
        }

        // ä¸Šä¼ å›¾ç‰‡åˆ° GitHub
        async function uploadImageToGitHub(file) {
            const config = JSON.parse(localStorage.getItem('githubConfig'));
            if (!config || !config.token) {
                alert('è¯·å…ˆé…ç½® GitHub');
                return;
            }

            // æ˜¾ç¤ºä¸Šä¼ ä¸­æç¤º
            const range = quill.getSelection(true);
            quill.insertText(range.index, 'ä¸Šä¼ å›¾ç‰‡ä¸­...', 'user');

            try {
                // è¯»å–æ–‡ä»¶ä¸º Base64
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const base64Data = e.target.result.split(',')[1];
                    
                    // ç”Ÿæˆæ–‡ä»¶åï¼ˆæ—¶é—´æˆ³ + åŸæ–‡ä»¶åï¼‰
                    const timestamp = Date.now();
                    const filename = `${timestamp}-${file.name}`;
                    const url = `https://api.github.com/repos/${config.username}/${config.repo}/contents/images/${filename}`;

                    try {
                        // ä¸Šä¼ åˆ° GitHub
                        const response = await fetch(url, {
                            method: 'PUT',
                            headers: {
                                'Authorization': `token ${config.token}`,
                                'Accept': 'application/vnd.github.v3+json',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                message: `ä¸Šä¼ å›¾ç‰‡: ${filename}`,
                                content: base64Data,
                                branch: 'main'
                            })
                        });

                        if (!response.ok) {
                            throw new Error('ä¸Šä¼ å¤±è´¥');
                        }

                        const result = await response.json();
                        
                        // è·å–å›¾ç‰‡çš„è®¿é—® URL
                        const imageUrl = `https://raw.githubusercontent.com/${config.username}/${config.repo}/main/images/${filename}`;
                        
                        // åˆ é™¤"ä¸Šä¼ ä¸­"æ–‡æœ¬
                        quill.deleteText(range.index, 10);
                        
                        // æ’å…¥å›¾ç‰‡
                        quill.insertEmbed(range.index, 'image', imageUrl);
                        quill.setSelection(range.index + 1);

                        console.log('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ:', imageUrl);
                    } catch (error) {
                        // åˆ é™¤"ä¸Šä¼ ä¸­"æ–‡æœ¬
                        quill.deleteText(range.index, 10);
                        alert('å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼š' + error.message);
                        console.error(error);
                    }
                };
                
                reader.readAsDataURL(file);
            } catch (error) {
                alert('è¯»å–å›¾ç‰‡å¤±è´¥ï¼š' + error.message);
                console.error(error);
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', loadConfig);
    </script>
</body>
</html>
