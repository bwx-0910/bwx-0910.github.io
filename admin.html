<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬”è®°ç®¡ç†åå°</title>
    
    <!-- Quill.js å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f5f7fa;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .setup-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .setup-section h2 {
            color: #333;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group textarea {
            min-height: 400px;
            font-family: 'Courier New', monospace;
            resize: vertical;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            margin-left: 10px;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .note-list {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .note-item {
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .note-item:hover {
            border-color: #667eea;
            background: #f9f9ff;
        }

        .note-info {
            flex: 1;
        }

        .note-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .note-meta {
            font-size: 12px;
            color: #666;
        }

        .note-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 6px 15px;
            font-size: 12px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-info {
            background: #e7f3ff;
            color: #0066cc;
            border: 1px solid #b3d9ff;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .code-block {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
            margin: 10px 0;
        }

        .editor-section {
            display: none;
        }

        .editor-section.active {
            display: block;
        }

        .preview {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-top: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ ç¬”è®°ç®¡ç†åå°</h1>
            <p>åœ¨çº¿ç¼–è¾‘å’Œç®¡ç†ä½ çš„è¯»ä¹¦ç¬”è®°</p>
        </div>

        <!-- GitHub è®¾ç½® -->
        <div class="setup-section" id="setupSection">
            <h2>âš™ï¸ GitHub é…ç½®</h2>
            
            <div class="alert alert-info">
                <strong>é¦–æ¬¡ä½¿ç”¨éœ€è¦é…ç½®</strong><br>
                éœ€è¦åˆ›å»ºä¸€ä¸ª GitHub Personal Access Token æ‰èƒ½åœ¨çº¿ç¼–è¾‘ç¬”è®°ã€‚
            </div>

            <div class="form-group">
                <label>GitHub ç”¨æˆ·å</label>
                <input type="text" id="githubUsername" value="bwx-0910" placeholder="ä½ çš„ GitHub ç”¨æˆ·å">
            </div>

            <div class="form-group">
                <label>ä»“åº“åç§°</label>
                <input type="text" id="repoName" value="bwx-0910.github.io" placeholder="ä»“åº“å">
            </div>

            <div class="form-group">
                <label>Personal Access Token</label>
                <input type="password" id="githubToken" placeholder="è¾“å…¥ä½ çš„ GitHub Token">
                <small style="color: #666; margin-top: 5px; display: block;">
                    <a href="https://github.com/settings/tokens/new?scopes=repo&description=Blog%20Editor" target="_blank">
                        ç‚¹å‡»è¿™é‡Œç”Ÿæˆ Token
                    </a>ï¼ˆéœ€è¦å‹¾é€‰ repo æƒé™ï¼‰
                </small>
            </div>

            <button class="btn btn-primary" onclick="saveConfig()">ä¿å­˜é…ç½®</button>
            
            <div style="margin-top: 20px;">
                <h3>å¦‚ä½•è·å– Tokenï¼Ÿ</h3>
                <ol style="color: #666; line-height: 1.8; margin-left: 20px;">
                    <li>è®¿é—® <a href="https://github.com/settings/tokens" target="_blank">GitHub Settings â†’ Tokens</a></li>
                    <li>ç‚¹å‡» "Generate new token (classic)"</li>
                    <li>å‹¾é€‰ <strong>repo</strong> æƒé™</li>
                    <li>ç”Ÿæˆå¹¶å¤åˆ¶ Token</li>
                    <li>ç²˜è´´åˆ°ä¸Šé¢çš„è¾“å…¥æ¡†</li>
                </ol>
            </div>
        </div>

        <!-- ç¬”è®°åˆ—è¡¨ -->
        <div class="note-list" id="noteList" style="display: none;">
            <h2>ğŸ“š æˆ‘çš„ç¬”è®°</h2>
            <button class="btn btn-primary" onclick="showEditor()">+ æ–°å»ºç¬”è®°</button>
            <div id="noteListContent" style="margin-top: 20px;"></div>
        </div>

        <!-- ç¼–è¾‘å™¨ -->
        <div class="editor-section" id="editorSection">
            <div class="setup-section">
                <h2 id="editorTitle">âœï¸ ç¼–è¾‘ç¬”è®°</h2>

                <div class="form-group">
                    <label>æ ‡é¢˜</label>
                    <input type="text" id="noteTitle" placeholder="ã€Šä¹¦åã€‹è¯»ä¹¦ç¬”è®°">
                </div>

                <div class="form-group">
                    <label>å›¾æ ‡ Emoji</label>
                    <input type="text" id="noteIcon" value="ğŸ“–" maxlength="2">
                </div>

                <div class="form-group">
                    <label>åˆ†ç±»</label>
                    <input type="text" id="noteCategory" placeholder="å¦‚ï¼šå¿ƒç†å­¦ã€å†å²ã€å•†ä¸š">
                </div>

                <div class="form-group">
                    <label>æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
                    <input type="text" id="noteTags" placeholder="æ ‡ç­¾1, æ ‡ç­¾2, æ ‡ç­¾3">
                </div>

                <div class="form-group">
                    <label>æ‘˜è¦</label>
                    <textarea id="noteExcerpt" rows="3" placeholder="ç®€çŸ­çš„æ‘˜è¦ï¼Œ100-200å­—..."></textarea>
                </div>

                <!-- ä¹¦ç±æ‘˜å½•åŒºåŸŸ -->
                <div class="form-group">
                    <label>
                        ğŸ“Œ ä¹¦ç±æ‘˜å½•
                        <span style="color: #999; font-size: 12px; font-weight: normal;">
                            è®°å½•ä¹¦ä¸­çš„ç²¾å½©æ®µè½å’Œé‡‘å¥
                        </span>
                    </label>
                    <div id="quotesContainer" style="margin-bottom: 10px;">
                        <!-- æ‘˜å½•åˆ—è¡¨å°†åŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <textarea id="newQuoteInput" rows="3" placeholder="è¾“å…¥ä¸€æ¡æ‘˜å½•..." style="flex: 1;"></textarea>
                        <button type="button" class="btn btn-primary" onclick="addQuote()" style="height: fit-content;">+ æ·»åŠ æ‘˜å½•</button>
                    </div>
                </div>

                <div class="form-group">
                    <label>
                        ç¬”è®°å†…å®¹ï¼ˆå¯Œæ–‡æœ¬ç¼–è¾‘ï¼‰
                        <span style="color: #999; font-size: 12px; font-weight: normal;">
                            æ”¯æŒåŠ ç²—ã€æ–œä½“ã€å¼•ç”¨ã€åˆ—è¡¨ç­‰æ ¼å¼
                        </span>
                    </label>
                    <!-- Quill å¯Œæ–‡æœ¬ç¼–è¾‘å™¨å®¹å™¨ -->
                    <div id="editor" style="background: white; min-height: 400px; border: 1px solid #ddd; border-radius: 8px;"></div>
                    <!-- éšè—çš„ textarea ç”¨äºå­˜å‚¨ Markdown -->
                    <textarea id="noteContent" style="display: none;"></textarea>
                </div>

                <div>
                    <button class="btn btn-primary" onclick="saveNote()">ğŸ’¾ ä¿å­˜ç¬”è®°</button>
                    <button class="btn btn-secondary" onclick="cancelEdit()">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentEditFile = null;
        let quill = null; // Quill ç¼–è¾‘å™¨å®ä¾‹
        let quotes = []; // å­˜å‚¨ä¹¦ç±æ‘˜å½•

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            initQuillEditor();
            loadConfig();
        });

        // åˆå§‹åŒ– Quill å¯Œæ–‡æœ¬ç¼–è¾‘å™¨
        function initQuillEditor() {
            quill = new Quill('#editor', {
                theme: 'snow',
                placeholder: 'å¼€å§‹å†™ç¬”è®°å§...\n\nğŸ’¡ æç¤ºï¼šä½¿ç”¨å¼•ç”¨æ ¼å¼ï¼ˆå¼•å·æŒ‰é’®ï¼‰æ¥æ ‡è®°æ‘˜å½•çš„å¥å­',
                modules: {
                    toolbar: [
                        // æ ¼å¼åŒ–
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        
                        // å¼•ç”¨å’Œä»£ç ï¼ˆé€‚åˆæ‘˜å½•ï¼‰
                        ['blockquote', 'code-block'],
                        
                        // åˆ—è¡¨
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        
                        // é¢œè‰²å’ŒèƒŒæ™¯ï¼ˆçªå‡ºé‡ç‚¹ï¼‰
                        [{ 'color': [] }, { 'background': [] }],
                        
                        // å¯¹é½æ–¹å¼
                        [{ 'align': [] }],
                        
                        // æ¸…é™¤æ ¼å¼
                        ['clean']
                    ]
                }
            });

            // æ·»åŠ è‡ªå®šä¹‰æ ·å¼è®©å¼•ç”¨æ›´ç¾è§‚
            const style = document.createElement('style');
            style.textContent = `
                .ql-editor blockquote {
                    background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
                    border-left: 5px solid #e17055;
                    padding: 15px 20px;
                    margin: 20px 0;
                    border-radius: 8px;
                    font-style: italic;
                    color: #2d3436;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                }
                .ql-editor {
                    font-size: 16px;
                    line-height: 1.8;
                    min-height: 400px;
                }
                .ql-editor strong {
                    color: #e74c3c;
                    font-weight: 700;
                }
                .ql-editor em {
                    color: #3498db;
                }
            `;
            document.head.appendChild(style);
        }

        // å°† Quill å†…å®¹è½¬æ¢ä¸º Markdown
        function quillToMarkdown() {
            const delta = quill.getContents();
            const html = quill.root.innerHTML;
            
            // ç®€å•çš„ HTML åˆ° Markdown è½¬æ¢
            let markdown = html;
            
            // æ ‡é¢˜
            markdown = markdown.replace(/<h1>(.*?)<\/h1>/g, '# $1\n\n');
            markdown = markdown.replace(/<h2>(.*?)<\/h2>/g, '## $1\n\n');
            markdown = markdown.replace(/<h3>(.*?)<\/h3>/g, '### $1\n\n');
            
            // æ ¼å¼åŒ–
            markdown = markdown.replace(/<strong>(.*?)<\/strong>/g, '**$1**');
            markdown = markdown.replace(/<em>(.*?)<\/em>/g, '*$1*');
            markdown = markdown.replace(/<u>(.*?)<\/u>/g, '_$1_');
            markdown = markdown.replace(/<s>(.*?)<\/s>/g, '~~$1~~');
            
            // å¼•ç”¨ï¼ˆé‡ç‚¹ï¼šæ‘˜å½•å¥å­ï¼‰
            markdown = markdown.replace(/<blockquote>(.*?)<\/blockquote>/gs, function(match, content) {
                return '\n> ' + content.replace(/<[^>]*>/g, '').trim() + '\n\n';
            });
            
            // åˆ—è¡¨
            markdown = markdown.replace(/<ul>(.*?)<\/ul>/gs, function(match, content) {
                return content.replace(/<li>(.*?)<\/li>/g, '- $1\n');
            });
            markdown = markdown.replace(/<ol>(.*?)<\/ol>/gs, function(match, content) {
                let index = 1;
                return content.replace(/<li>(.*?)<\/li>/g, function(m, item) {
                    return `${index++}. ${item}\n`;
                });
            });
            
            // æ®µè½
            markdown = markdown.replace(/<p>(.*?)<\/p>/g, '$1\n\n');
            
            // æ¸…ç† HTML æ ‡ç­¾
            markdown = markdown.replace(/<[^>]*>/g, '');
            
            // æ¸…ç†å¤šä½™ç©ºè¡Œ
            markdown = markdown.replace(/\n{3,}/g, '\n\n');
            
            return markdown.trim();
        }

        // æ·»åŠ æ‘˜å½•
        function addQuote() {
            const input = document.getElementById('newQuoteInput');
            const text = input.value.trim();
            
            if (!text) {
                alert('è¯·è¾“å…¥æ‘˜å½•å†…å®¹');
                return;
            }
            
            quotes.push(text);
            input.value = '';
            renderQuotes();
        }

        // åˆ é™¤æ‘˜å½•
        function removeQuote(index) {
            quotes.splice(index, 1);
            renderQuotes();
        }

        // æ¸²æŸ“æ‘˜å½•åˆ—è¡¨
        function renderQuotes() {
            const container = document.getElementById('quotesContainer');
            
            if (quotes.length === 0) {
                container.innerHTML = '<p style="color: #999; font-size: 14px; padding: 10px;">æš‚æ— æ‘˜å½•ï¼Œç‚¹å‡»ä¸‹æ–¹æ·»åŠ </p>';
                return;
            }
            
            container.innerHTML = quotes.map((quote, index) => `
                <div class="quote-item">
                    <div class="quote-text">"${quote}"</div>
                    <button type="button" class="quote-delete" onclick="removeQuote(${index})">åˆ é™¤</button>
                </div>
            `).join('');
        }

        // å°† Markdown è½¬æ¢ä¸º Quill HTML
        function markdownToQuill(markdown) {
            if (!markdown) return '';
            
            let html = markdown;
            
            // æ ‡é¢˜
            html = html.replace(/^### (.*?)$/gm, '<h3>$1</h3>');
            html = html.replace(/^## (.*?)$/gm, '<h2>$1</h2>');
            html = html.replace(/^# (.*?)$/gm, '<h1>$1</h1>');
            
            // å¼•ç”¨
            html = html.replace(/^> (.*?)$/gm, '<blockquote>$1</blockquote>');
            
            // åŠ ç²—
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // æ–œä½“
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // åˆ é™¤çº¿
            html = html.replace(/~~(.*?)~~/g, '<s>$1</s>');
            
            // åˆ—è¡¨ï¼ˆç®€å•å¤„ç†ï¼‰
            html = html.replace(/^- (.*?)$/gm, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
            
            // æ®µè½
            html = html.replace(/^(?!<[hbu]|<li)(.*?)$/gm, '<p>$1</p>');
            
            return html;
        }

        // åŠ è½½é…ç½®
        function loadConfig() {
            const config = localStorage.getItem('githubConfig');
            if (config) {
                const data = JSON.parse(config);
                document.getElementById('githubUsername').value = data.username || 'bwx-0910';
                document.getElementById('repoName').value = data.repo || 'bwx-0910.github.io';
                document.getElementById('githubToken').value = data.token || '';
                
                if (data.token) {
                    document.getElementById('setupSection').style.display = 'none';
                    document.getElementById('noteList').style.display = 'block';
                    loadNotes();
                }
            }
        }

        // ä¿å­˜é…ç½®
        function saveConfig() {
            const username = document.getElementById('githubUsername').value;
            const repo = document.getElementById('repoName').value;
            const token = document.getElementById('githubToken').value;

            if (!username || !repo || !token) {
                alert('è¯·å¡«å†™æ‰€æœ‰å­—æ®µ');
                return;
            }

            localStorage.setItem('githubConfig', JSON.stringify({
                username: username,
                repo: repo,
                token: token
            }));

            alert('é…ç½®å·²ä¿å­˜ï¼');
            document.getElementById('setupSection').style.display = 'none';
            document.getElementById('noteList').style.display = 'block';
            loadNotes();
        }

        // åŠ è½½ç¬”è®°åˆ—è¡¨
        async function loadNotes() {
            const config = JSON.parse(localStorage.getItem('githubConfig'));
            const url = `https://api.github.com/repos/${config.username}/${config.repo}/contents/notes`;

            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `token ${config.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!response.ok) {
                    throw new Error('æ— æ³•åŠ è½½ç¬”è®°åˆ—è¡¨');
                }

                const files = await response.json();
                const mdFiles = files.filter(f => 
                    f.name.endsWith('.md') && 
                    f.name !== 'ç¬”è®°æ¨¡æ¿.md' && 
                    f.name !== 'README.md'
                );

                displayNotes(mdFiles);
            } catch (error) {
                alert('åŠ è½½å¤±è´¥ï¼š' + error.message);
                console.error(error);
            }
        }

        // æ˜¾ç¤ºç¬”è®°åˆ—è¡¨
        function displayNotes(files) {
            const container = document.getElementById('noteListContent');
            
            if (files.length === 0) {
                container.innerHTML = '<p style="color: #666; padding: 20px;">è¿˜æ²¡æœ‰ç¬”è®°ï¼Œç‚¹å‡»ä¸Šé¢çš„æŒ‰é’®åˆ›å»ºç¬¬ä¸€ç¯‡ç¬”è®°å§ï¼</p>';
                return;
            }

            container.innerHTML = files.map(file => `
                <div class="note-item">
                    <div class="note-info">
                        <div class="note-title">${file.name.replace('.md', '')}</div>
                        <div class="note-meta">æ–‡ä»¶å: ${file.name}</div>
                    </div>
                    <div class="note-actions">
                        <button class="btn btn-primary btn-small" onclick="editNote('${file.name}')">ç¼–è¾‘</button>
                        <button class="btn btn-small" style="background: #dc3545; color: white;" onclick="deleteNote('${file.name}', event)">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        // æ˜¾ç¤ºç¼–è¾‘å™¨
        function showEditor() {
            document.getElementById('editorSection').classList.add('active');
            document.getElementById('noteList').style.display = 'none';
            document.getElementById('editorTitle').textContent = 'âœï¸ æ–°å»ºç¬”è®°';
            
            // æ¸…ç©ºè¡¨å•
            document.getElementById('noteTitle').value = '';
            document.getElementById('noteIcon').value = 'ğŸ“–';
            document.getElementById('noteCategory').value = '';
            document.getElementById('noteTags').value = '';
            document.getElementById('noteExcerpt').value = '';
            
            // æ¸…ç©ºæ‘˜å½•
            quotes = [];
            renderQuotes();
            
            // æ¸…ç©º Quill ç¼–è¾‘å™¨
            quill.setText('');
            
            currentEditFile = null;
        }

        // ç¼–è¾‘ç¬”è®°
        async function editNote(filename) {
            const config = JSON.parse(localStorage.getItem('githubConfig'));
            const url = `https://api.github.com/repos/${config.username}/${config.repo}/contents/notes/${filename}`;

            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `token ${config.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                const file = await response.json();
                // æ­£ç¡®è§£ç  UTF-8 ä¸­æ–‡å†…å®¹
                const content = decodeURIComponent(escape(atob(file.content)));
                
                // è§£æ Front Matter
                const match = content.match(/^---\n([\s\S]*?)\n---\n([\s\S]*)$/);
                if (match) {
                    const frontmatter = match[1];
                    const body = match[2];
                    
                    // è§£æå„ä¸ªå­—æ®µ
                    const title = frontmatter.match(/title:\s*(.+)/)?.[1] || '';
                    const icon = frontmatter.match(/icon:\s*(.+)/)?.[1] || 'ğŸ“–';
                    const category = frontmatter.match(/category:\s*(.+)/)?.[1] || '';
                    const tags = frontmatter.match(/tags:\s*(.+)/)?.[1] || '';
                    const excerpt = frontmatter.match(/excerpt:\s*(.+)/)?.[1] || '';
                    
                    // è§£ææ‘˜å½•æ•°ç»„
                    const quotesMatch = frontmatter.match(/quotes:\s*(\[[\s\S]*?\])/);
                    if (quotesMatch) {
                        try {
                            quotes = JSON.parse(quotesMatch[1]);
                        } catch (e) {
                            console.error('è§£ææ‘˜å½•å¤±è´¥:', e);
                            quotes = [];
                        }
                    } else {
                        quotes = [];
                    }
                    
                    document.getElementById('noteTitle').value = title;
                    document.getElementById('noteIcon').value = icon;
                    document.getElementById('noteCategory').value = category;
                    document.getElementById('noteTags').value = tags;
                    document.getElementById('noteExcerpt').value = excerpt;
                    
                    // æ¸²æŸ“æ‘˜å½•åˆ—è¡¨
                    renderQuotes();
                    
                    // å°† Markdown å†…å®¹åŠ è½½åˆ° Quill ç¼–è¾‘å™¨
                    const html = markdownToQuill(body.trim());
                    quill.root.innerHTML = html;
                }
                
                currentEditFile = {
                    name: filename,
                    sha: file.sha
                };
                
                document.getElementById('editorSection').classList.add('active');
                document.getElementById('noteList').style.display = 'none';
                document.getElementById('editorTitle').textContent = 'âœï¸ ç¼–è¾‘ç¬”è®°: ' + filename;
                
            } catch (error) {
                alert('åŠ è½½ç¬”è®°å¤±è´¥ï¼š' + error.message);
            }
        }

        // ä¿å­˜ç¬”è®°
        async function saveNote() {
            const title = document.getElementById('noteTitle').value;
            const icon = document.getElementById('noteIcon').value;
            const category = document.getElementById('noteCategory').value;
            const tags = document.getElementById('noteTags').value;
            const excerpt = document.getElementById('noteExcerpt').value;
            
            // ä» Quill ç¼–è¾‘å™¨è·å–å†…å®¹å¹¶è½¬æ¢ä¸º Markdown
            const content = quillToMarkdown();

            if (!title || !content) {
                alert('è¯·è‡³å°‘å¡«å†™æ ‡é¢˜å’Œå†…å®¹');
                return;
            }

            // ç”Ÿæˆå®Œæ•´çš„ Markdown å†…å®¹
            const today = new Date().toISOString().split('T')[0];
            const quotesJson = JSON.stringify(quotes);
            const fullContent = `---
title: ${title}
icon: ${icon}
date: ${today}
category: ${category}
tags: ${tags}
excerpt: ${excerpt}
quotes: ${quotesJson}
---

${content}`;

            // ç”Ÿæˆæ–‡ä»¶å
            const filename = currentEditFile ? currentEditFile.name : 
                            (title.replace(/[ã€Šã€‹]/g, '').replace(/\s+/g, '-') + '.md');

            const config = JSON.parse(localStorage.getItem('githubConfig'));
            const url = `https://api.github.com/repos/${config.username}/${config.repo}/contents/notes/${filename}`;

            try {
                const data = {
                    message: currentEditFile ? `æ›´æ–°ç¬”è®°: ${filename}` : `æ–°å»ºç¬”è®°: ${filename}`,
                    content: btoa(unescape(encodeURIComponent(fullContent))),
                    branch: 'main'
                };

                if (currentEditFile) {
                    data.sha = currentEditFile.sha;
                }

                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${config.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error('ä¿å­˜å¤±è´¥');
                }

                alert('âœ… ä¿å­˜æˆåŠŸï¼\n\nè¯·ç­‰å¾… 1-2 åˆ†é’Ÿè®© GitHub Pages æ„å»ºå®Œæˆã€‚');
                cancelEdit();
                loadNotes();
                
            } catch (error) {
                alert('ä¿å­˜å¤±è´¥ï¼š' + error.message);
                console.error(error);
            }
        }

        // åˆ é™¤ç¬”è®°
        async function deleteNote(filename, event) {
            event.stopPropagation(); // é˜²æ­¢è§¦å‘çˆ¶å…ƒç´ çš„ç‚¹å‡»äº‹ä»¶
            
            if (!confirm(`ç¡®å®šè¦åˆ é™¤"${filename}"å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                return;
            }

            const config = JSON.parse(localStorage.getItem('githubConfig'));
            const url = `https://api.github.com/repos/${config.username}/${config.repo}/contents/notes/${filename}`;

            try {
                // é¦–å…ˆè·å–æ–‡ä»¶ä¿¡æ¯ä»¥è·å¾— sha
                const getResponse = await fetch(url, {
                    headers: {
                        'Authorization': `token ${config.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!getResponse.ok) {
                    throw new Error('æ— æ³•è·å–æ–‡ä»¶ä¿¡æ¯');
                }

                const fileInfo = await getResponse.json();

                // åˆ é™¤æ–‡ä»¶
                const deleteResponse = await fetch(url, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `token ${config.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `åˆ é™¤ç¬”è®°: ${filename}`,
                        sha: fileInfo.sha,
                        branch: 'main'
                    })
                });

                if (!deleteResponse.ok) {
                    throw new Error('åˆ é™¤å¤±è´¥');
                }

                alert('âœ… åˆ é™¤æˆåŠŸï¼\n\nè¯·ç­‰å¾… 1-2 åˆ†é’Ÿè®©æ›´æ”¹ç”Ÿæ•ˆã€‚');
                loadNotes(); // é‡æ–°åŠ è½½åˆ—è¡¨
                
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥ï¼š' + error.message);
                console.error(error);
            }
        }

        // å–æ¶ˆç¼–è¾‘
        function cancelEdit() {
            document.getElementById('editorSection').classList.remove('active');
            document.getElementById('noteList').style.display = 'block';
            currentEditFile = null;
            
            // æ¸…ç©º Quill ç¼–è¾‘å™¨
            quill.setText('');
            
            // æ¸…ç©ºå…¶ä»–è¡¨å•å­—æ®µ
            document.getElementById('noteTitle').value = '';
            document.getElementById('noteIcon').value = 'ğŸ“–';
            document.getElementById('noteCategory').value = '';
            document.getElementById('noteTags').value = '';
            document.getElementById('noteExcerpt').value = '';
            
            // æ¸…ç©ºæ‘˜å½•
            quotes = [];
            renderQuotes();
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', loadConfig);
    </script>
</body>
</html>
